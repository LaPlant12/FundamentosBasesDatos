--script para crear la BD muebleria
--fecha de creación 1 dic 2020
--fecha de ult mod 14 dic 2020
--autor: David Garcia Leon; lista=10
--TECNM ITL
-- Torreon coah

CREATE DATABASE MUEBLERIA
GO --GO marca el final de una ejecución, para posteriormente regresar a ese punto después del go y ejecuta lo que sigue seleccionado

USE MUEBLERIA
GO

CREATE TABLE MUEBLE
(
	CLAVE_MUEBLE SMALLINT,
	NOMBRE_MUEBLE VARCHAR(25),
	COSTO_MUEBLE MONEY,
	PRECIOV_MUEBLE AS (COSTO_MUEBLE + COSTO_MUEBLE * .2), --Atributo calculado, punto extra? :)
	PRIMARY KEY (CLAVE_MUEBLE)
)
GO

CREATE TABLE PIEZA
(
	ID_PIEZA SMALLINT,
	NOMBRE VARCHAR(20),
	PRIMARY KEY (ID_PIEZA)
)
GO

CREATE TABLE ESTANTE
(
	NUMERO_ESTANTE SMALLINT,
	PESO_ESTANTE REAL,
	ALTURA_ESTANTE REAL,
	PASILLO_ESTANTE SMALLINT,
	PRIMARY KEY (NUMERO_ESTANTE)
)
GO

CREATE TABLE MUEBLE_PIEZA
(
	CLAVE_MUEBLE SMALLINT,
	ID_PIEZA SMALLINT,
	NUMERO_PIEZA SMALLINT,
	PRIMARY KEY (CLAVE_MUEBLE, ID_PIEZA),
	--LLAVES FORANEAS
	CONSTRAINT FK_CLAVE_MUEBLE
	FOREIGN KEY (CLAVE_MUEBLE) REFERENCES MUEBLE(CLAVE_MUEBLE),
	CONSTRAINT FK_ID_PIEZA 
	FOREIGN KEY (ID_PIEZA) REFERENCES PIEZA(ID_PIEZA)
)
GO

CREATE TABLE PIEZA_ESTANTE
(
	ID_PIEZA SMALLINT,
	NUMERO_ESTANTE SMALLINT,
	PIEZAS_ALMACENADAS SMALLINT,
	PRIMARY KEY (ID_PIEZA, NUMERO_ESTANTE),
	--LLAVES FORANEAS
	CONSTRAINT FK_ID_PIEZA_ESTANTE
	FOREIGN KEY (ID_PIEZA) REFERENCES PIEZA(ID_PIEZA),
	CONSTRAINT FK_NUMERO_ESTANTE
	FOREIGN KEY (NUMERO_ESTANTE) REFERENCES ESTANTE(NUMERO_ESTANTE)
)
GO

--DATOS DE MUEBLE
INSERT INTO MUEBLE
VALUES (001,'Sillón', 6000)
GO

INSERT INTO MUEBLE
VALUES (002, 'Closet', 2500)
GO

INSERT INTO MUEBLE
VALUES (003, 'Cama', 8000)
GO

INSERT INTO MUEBLE
VALUES (004, 'Mesita', 1000)
GO

INSERT INTO MUEBLE
VALUES (005, 'Comedor', 6500)
GO

INSERT INTO MUEBLE
VALUES (006, 'Silla', 800)
GO

INSERT INTO MUEBLE
VALUES (007, 'Mesa TV', 3500)
GO

INSERT INTO MUEBLE
VALUES (008, 'Buró', 1200)
GO

INSERT INTO MUEBLE 
VALUES (009, 'Librero', 1600)
GO

INSERT INTO MUEBLE 
VALUES (010, 'Escritorio', 3000)
GO

--VALORES DE PIEZA
INSERT INTO PIEZA
VALUES (101, 'Madera')
GO

INSERT INTO PIEZA
VALUES (102, 'Tornillo')
GO

INSERT INTO PIEZA
VALUES (103, 'Clavo')
GO

INSERT INTO PIEZA
VALUES (104, 'Pata')
GO

INSERT INTO PIEZA
VALUES (105, 'Relleno')
GO

INSERT INTO PIEZA 
VALUES (106, 'Tela')
GO

INSERT INTO PIEZA
VALUES (107, 'Armazon')
GO

INSERT INTO PIEZA 
VALUES (108, 'Bisagra')
GO

INSERT INTO PIEZA
VALUES (109, 'Jaladera')
GO

INSERT INTO PIEZA
VALUES (110, 'Cerradura')
GO

--VALORES DE MUEBLE_PIEZA
INSERT INTO MUEBLE_PIEZA
VALUES (001,101,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (001,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (001,106,7)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (001,105,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (002,101,7)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (002,102,20)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (002,108,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (002,109,2)
GO

INSERT INTO MUEBLE_PIEZA
VALUES (002,110,1)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(003,107,2)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(003,106,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(003,105,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(003,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(004,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(004,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(005,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(005,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(007,101,8)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(007,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(008,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(008,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(009,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(009,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(010,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(010,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(006,101,5)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(006,104,4)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(006,105,2)
GO

INSERT INTO MUEBLE_PIEZA
VALUES(006,103,10)
GO

--VALORES DE ESTANTE
INSERT INTO ESTANTE
VALUES (1000, 703.42, 4.3,1)
GO

INSERT INTO ESTANTE
VALUES (2000, 834.2, 4.5,1)
GO

INSERT INTO ESTANTE
VALUES (3000, 544.3, 3.6,2)
GO

INSERT INTO ESTANTE
VALUES (4000, 678.6, 4.9,2)
GO

INSERT INTO ESTANTE
VALUES (5000, 820, 4.2, 3)
GO

INSERT INTO ESTANTE
VALUES (6000, 812.2, 4.4, 3)
GO

INSERT INTO ESTANTE
VALUES (7000, 786.8, 3.9, 4)
GO

INSERT INTO ESTANTE
VALUES (8000, 764.31, 4.1, 4)
GO

INSERT INTO ESTANTE
VALUES (9000, 930, 5, 5)
GO

INSERT INTO ESTANTE
VALUES (10000, 923.84, 5, 5)
GO

--VALORES DE PIEZA_ESTANTE
INSERT INTO PIEZA_ESTANTE
VALUES(101,1000,520)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(102,2000,12045)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(103,3000,13453)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(104,4000,780)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(105,5000,872)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(106,6000,650)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(107,7000,430)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(108,8000,224)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(109,9000,167)
GO

INSERT INTO PIEZA_ESTANTE
VALUES(110,10000,112)
GO


--Consultas
--1 Encontrar cuantos piezas de madera usa un closet
SELECT NUMERO_PIEZA
FROM MUEBLE_PIEZA
WHERE ID_PIEZA LIKE (SELECT ID_PIEZA
					FROM PIEZA
					WHERE NOMBRE LIKE 'Madera')
	AND CLAVE_MUEBLE LIKE (SELECT CLAVE_MUEBLE
							FROM MUEBLE
							WHERE NOMBRE_MUEBLE LIKE 'Closet')
--2 Encontrar que muebles usan tela
SELECT NOMBRE_MUEBLE
FROM MUEBLE
WHERE CLAVE_MUEBLE IN
	(SELECT CLAVE_MUEBLE
	FROM MUEBLE_PIEZA
	WHERE ID_PIEZA IN (SELECT ID_PIEZA
						FROM PIEZA
						WHERE NOMBRE LIKE 'Tela'))
--3 Encontrar estantes que miden 4.5 metros o más
SELECT NUMERO_ESTANTE
FROM ESTANTE
WHERE ALTURA_ESTANTE >= 4.5

--4 Encontrar estante donde haya tela
SELECT NUMERO_ESTANTE
FROM PIEZA_ESTANTE
WHERE ID_PIEZA IN (SELECT ID_PIEZA
					FROM PIEZA
					WHERE NOMBRE LIKE 'Tela')
--5 Encontrar que piezas usa una silla
SELECT NOMBRE
FROM PIEZA
WHERE ID_PIEZA IN 
		(SELECT ID_PIEZA 
		FROM MUEBLE_PIEZA
		WHERE CLAVE_MUEBLE IN (SELECT CLAVE_MUEBLE 
								FROM MUEBLE 
								WHERE NOMBRE_MUEBLE LIKE 'Silla'))
--6 Ordenar estantes por peso
SELECT NUMERO_ESTANTE, PESO_ESTANTE
FROM ESTANTE
ORDER BY (PESO_ESTANTE)
--7 Ordenar muebles alfabéticamente
SELECT * FROM MUEBLE
ORDER BY (NOMBRE_MUEBLE)

--8 Ordenar muebles por precio 
SELECT * FROM MUEBLE
ORDER BY (PRECIOV_MUEBLE) 
--9 ORDENAR MUEBLES POR PRECIO DE MAYOR A MENOD
SELECT * FROM MUEBLE
ORDER BY (PRECIOV_MUEBLE) DESC
--10 ORDENAR PIEZAS POR EXISTENCIAS
SELECT * FROM PIEZA_ESTANTE
ORDER BY PIEZAS_ALMACENADAS DESC
--11 PROMEDIO DE ALTURA DE ALMACENES
SELECT AVG(ALTURA_ESTANTE) AS PROMEDIOALTURA
FROM ESTANTE
--12 PRECIO DEL MUEBLE MAS CARO
SELECT MAX(PRECIOV_MUEBLE) AS MAS_CARO
FROM MUEBLE
--13 PIEZAS CON MENOS EXISTENCIAS
SELECT MIN(PIEZAS_ALMACENADAS)
FROM PIEZA_ESTANTE
--14  CUANTOS MUEBLES VENDEN?
SELECT COUNT(CLAVE_MUEBLE) AS CANTIDADMUEBLES
FROM MUEBLE
--15 NUMERO TOTAL DE PIEZAS ALMACENADAS
SELECT SUM(PIEZAS_ALMACENADAS) AS TOTAL_PIEZAS
FROM PIEZA_ESTANTE
--16 NUMERO DE ESTANTES
SELECT COUNT (NUMERO_ESTANTE) AS ESTANTE
FROM ESTANTE
--17 EL PESO DEL PRIMER ESTANTE ESTANTE AHORA ES 600 KG
UPDATE ESTANTE
SET PESO_ESTANTE = 600
WHERE NUMERO_ESTANTE = 1000
--18 LOS SILLONES TIENEN UN 25% MENOS DE COSTO 
UPDATE MUEBLE
SET COSTO_MUEBLE = COSTO_MUEBLE - COSTO_MUEBLE *.25
WHERE NOMBRE_MUEBLE LIKE 'Sillon'
--19 LOS CLOSETS AHORA USAN 25 TORNILLOS
UPDATE MUEBLE_PIEZA
SET NUMERO_PIEZA = 25
WHERE CLAVE_MUEBLE = 002 AND ID_PIEZA = 102
--20 LA TIENDA YA NO QUIERE VENDER LIBREROS
	--CONSTRAINT FK_CLAVE_MUEBLE
	--FOREIGN KEY (CLAVE_MUEBLE) REFERENCES MUEBLE(CLAVE_MUEBLE),
	--CONSTRAINT FK_ID_PIEZA 
	--FOREIGN KEY (ID_PIEZA) REFERENCES PIEZA(ID_PIEZA)
DELETE FROM MUEBLE_PIEZA WHERE CLAVE_MUEBLE = (SELECT CLAVE_MUEBLE FROM MUEBLE WHERE NOMBRE_MUEBLE LIKE 'Librero')
DELETE FROM MUEBLE WHERE NOMBRE_MUEBLE LIKE 'Librero'

--INDICES
--CREAR INDICE CON EL NOMBRE DEL MUEBLE
CREATE INDEX IDX_NOMBRE_MUEBLE ON MUEBLE(NOMBRE_MUEBLE)
--CREAR INDICE CON EL NOMBRE DE LAS PIEZAS
CREATE INDEX IDX_NOMBRE_PIEZA ON PIEZA(NOMBRE)


